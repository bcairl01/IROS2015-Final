%%% Experimental Results %%%

	\begin{figure}[t!]\centering
		\centering
		\SetImage{\ImageWidthRatio}{bluefoot_standing.png}
		\caption{ The BlueFoot Quadruped.}
		\label{fig::bluefoot}
		\PostImageCloseSpace
	\end{figure}
\subsection{Experimental Platform}

We will be applying the NARX-NN compensator to our in-house developed robot, the BlueFoot Quadruped, shown in Figure~\ref{fig::bluefoot}. BlueFoot was designed for studies dealing with navigation on various types of terrain, as well as perception and 3D scene reconstruction. BlueFoot has 22-degrees of freedom with four revolute joints on each leg. BlueFoot's joints are controlled via smart-servo actuators which provide position, velocity and loading feedback. Each of BlueFoot's feet includes a binary-state contact sensor. Additionally, BlueFoot's trunk contains a 9-axis inertial measurement unit (IMU), GPS, and a vision sensor array consisting of a planar LIDAR and a stereo camera pair.
%%%%
% This has nothing to do with the matter of the paper really, and more to do with the physical robot implementation
%BlueFoot is controlled by a dual-processor autopilot unit (given the alias \emph{Lower Brain; LB}) and a 2 GHz  quad-core computer (\emph{Upper Brain; UB}). The LB consists of a 220 MHz main processor and an 80 MHz co-processor  unit and manages low-level tasks such as servo control;  ground station software for handling wireless communications; IMU and GPS sensor handling; Kalman filtering; and platform motion controls. As a result, motion controls (such as platform stabilization and gaiting) and its tightly associated feedback channels can be largely decoupled from high-level UB controls. The UB handles camera and LIDAR processing; navigation; and trajectory planning.
%%%%
We are also integrating load sensors into BlueFoot's feet for the proposed trunk stabilization algorithm implementation. 

%BlueFoot is currently implemented to walk using CPG-driven gaits, and will soon be applied to 
%studies dealing with rough-terrain navigation. We are currently reimplementing BlueFoot's
%feet with load sensors so that our proposed trunk compensator can be implemented.


\subsection{Simulated Platform}

	\begin{figure}[b!]\centering
		\vspace{-5mm}
		\SetImage{\ImageWidthRatio}{simulator_walk.png}
		\caption{ The BlueFoot Quadruped simulator during gaiting. }
		\label{fig::bluefoot}
	\end{figure}
The effectiveness of the proposed trunk stabilizer is validated through a series of detailed simulation studies. The simulator is implemented using the Open Dynamics Engine (ODE) \cite{OpenDynamicsEngine} and models the BlueFoot platform with reasonable accuracy. Parameters of the simulated robot body, such as internal joint update gains, have been carefully tuned so that the simulator provides a high-fidelity representation of the physical platform.

In our simulations, the trunk states $p_{b}$ and $\dot{p}_{b}$ are not measured as part of the system output and are not incorporated into the controller. This does not change the general form of the controller. Ideally, $\dot{p}_{b}$ would be generated from odometry measurements and ${p}_{b}$ would be estimated via a localization algorithm in absence of GPS, which has not yet been implemented for our platform. It will be shown that this does not compromise the general effectiveness of the compensator.

In the ensuing simulation studies, to closely mimic  the real platform and reduce simulated idealities, we have injected noise signals to various state measurements, e.g., angular position and velocities of the trunk. On the actual platform we are utilizing IMU measurements to estimate trunk pose via an extended Kalman filter.

%In simulation, angular position and velocity states of the trunk are gathered from ideal simulator 
%feedback outputs and artificially corrupted via respective, applied noise models.
%On the physical platform, the orientation of the trunk is estimated using an Extended Kalman
%Filter (EKF). To better emulate the performance of the EKF in simulation, trunk orientation signals are mixed
%with additive Gaussian-white (AGW) noise and an additive base-band drift signal. Similarly, gyroscopic
 %measurements are emulated using simulated angular velocity signals are also corrupted with AGW noise.

Although contact forces on each foot are accessible, we estimate the force at each foot using a combination of trunk 3-axis accelerometers and foot contact data. Assuming a rigid system and a uniform distribution of forces to each planted foot, a rough estimate of the force applied to each \Ith planted foot, $\hat{f}_{i}$, can be generated by:
	\vspace{-2mm}
	\begin{equation}
		\hat{f}_{i} = {m_{T}\mu_{i}} \left(\ddot{p}_{b} - \vec{g}\right)/{\sum_{j=1}^{4}{\mu_{j}}}
	\end{equation}
where $m_{T}$ represents the total system mass; $\mu_{i}\in \{0,1\}$ is the contact state of the \Ith foot (a value $\mu_{i}=1$ represents contact); $\vec{g}$ is the gravity vector; and $\ddot{p}_{b}$ is the trunk acceleration in the world frame. Ideally, the measurement of ${f}_{i}$ would be obtained via a 3-axis force-torque sensor placed at each foot.


\subsection{Simulation Studies}


In the simulations, the NARX-NN compensator is applied to the quadruped as it executes a stable CPG-driven trot gait depicted in  Figure~\ref{fig::quadruped_walking}. In these trials, gaiting frequency is adjusted accordingly to achieve particular forward speeds.

NARX-NN parameters are fixed for all trials with learning-rate  parameters set to $\beta=0.0001$, $\zeta=0.0005$ and $\lambda = 0.01$. The NARX-Network is configured with two hidden layers containing 50 neurons each. Each input and hidden-layer neuron is modeled using a symmetric sigmoid activation function. Output layer neurons are modeled using linear activation functions to avoid output-scaling saturation issues. Figure~\ref{fig::fast} exemplifies the convergence of the NARX-NN prediction error when the platform executes a gait at  100~$\frac{mm}{s}$ with $\alpha = 0.35$.

\begin{figure}[h!]
	\centering
	\begin{subfigure}{0.475\textwidth}
		\centering
		\SetImage{\ImageWidthRatioSub}{aux_V_80mms_nN_50_nL_2_pos.png}
		\caption{ }
	\end{subfigure}
	\begin{subfigure}{0.475\textwidth}
		\centering
		\SetImage{\ImageWidthRatioSub}{aux_V_100mms_nN_50_nL_2_pos.png}
		\caption{ } 
	\end{subfigure}
	\begin{subfigure}{0.475\textwidth}
		\centering
		\SetImage{\ImageWidthRatioSub}{aux_V_100mms_nN_50_nL_2_nns.png}
		\caption{ } 
	\end{subfigure}
	\caption{ 
		\textbf{a)} Trunk orientation during 80 $\frac{mm}{s}$ gait with mixing parameter set to $\alpha = 0.35$;
		\textbf{b)} Trunk orientation during 100 $\frac{mm}{s}$ gait with mixing parameter set to $\alpha = 0.35$;
		\textbf{c)} NARX Network MSE convergence for trial shown in \textbf{(b)}.
	}
	\label{fig::fast}
	\PostImageCloseSpace
\end{figure}

All simulated trials are performed over a period of 60 seconds each. During the first 10 seconds of each simulation, the robot moves from sitting position to a standing position and initiates walking. During each simulation period, the NARX-NN compensator is activated (not training)  and deactivated (training)  every 10 seconds. Figure~\ref{fig::alpha_tests} depicts initial set of simulation results showing the effect of varying the mixing parameter $\alpha\in\{0.125, 0.25, 0.35\}$. For all such trials, the robot performs a trot-gait which achieves a forward speed of 60 $\frac{mm}{s}$. We expect that as $\alpha$ increases, the compensator will have greater authority over trunk stabilization. From these results, we observe that for all $\alpha$, disturbance magnitude is decreased to some extent. However, for smaller $\alpha$, the compensator is less effectual due to the fact that it has less authority over joint reference signals.  From the results in Figure~\ref{fig::alpha_tests} \textbf{c)}, we see that the compensator improves pitch stability by more than roughly 50\% and roll stability by more than 60\%. Figure~\ref{fig::fast} shows the compensator's performance at higher gaiting speeds of 80 $\frac{mm}{s}$ and 100 $\frac{mm}{s}$. Here the controller improves both pitch and roll by nearly 50\% and 40\% of the  uncompensated signal magnitude, respectively.

%Larger values of $\alpha$ causes for undesirable effects on the originally stable CPG gait. Hence, we have selected $\alpha=0.25$ for normal 
%operation as it seems to balance the trade-off between compensator efficacy and the risk possible gait destabilization.
%\begin{figure}[t!]
%	\centering
%	\begin{subfigure}{0.475\textwidth}
%		\centering
%		\SetImage{\ImageWidthRatioSub}{aux_V_80mms_nN_50_nL_2_vel.png}
%		\caption{ }
%	\end{subfigure}
%	\begin{subfigure}{0.475\textwidth}
%		\centering
%		\SetImage{\ImageWidthRatioSub}{aux_V_100mms_nN_50_nL_2_vel.png}
%		\caption{ } 
%	\end{subfigure}
%	\caption{ 
%		\textbf{a)} Angular rate of trunk during 80 $\frac{mm}{s}$ gait with mixing parameter set to $\alpha = 0.35$
%		\textbf{b)} Angular rate of trunk during 100 $\frac{mm}{s}$ gait with mixing parameter set to $\alpha = 0.35$
%	}
%	\label{fig::fast}
%	\PostImageCloseSpace
%\end{figure}

As may be inferred from the above observations, tuning the parameter $\alpha$ to achieve the desired performance is crucial. 
As the parameter $\alpha$ gets smaller (approaching zero), one recovers the original stabilized CPG generated gait (i.e., a CPG gait properly mixed with ZMP) and therefore loss of trunk stabilization. As $\alpha$ approaches one, the stabilized CPG generated gait is no longer utilized and the NARX network is generating the total gait for the robot. Since the NARX network is trained to attain a constant orientation of the trunk and reduces disturbances to the trunk, the generated gait does not take into account efficiency or  stability of the gait. Therefore, it is crucial that a proper $\alpha$ (i.e., mixing of the CPG gait and the corrected gait) be chosen. To this extent, from our simulation studies, a value of 0.35 for $\alpha$ seems to be very effective. The gait corresponding to $\alpha > 0.375$ creates inefficient or ununsable gaits for the robot (i.e., the forward movement is not achieved). In a sense, the parameter $\alpha$ reflects the stability margin of the properly stabilized CPG gait. One may consider a cost function to appropriately optimize the parameter $\alpha$. Nevertheless, we believe our simulation studies depict a stabilization results using a close-to-optimal choice of $\alpha$.


\vspace{-2mm}
\subsection{Video Submission}


A video of the simulated robot has been submitted along with this paper. This video shows the robot balancing a mass (about the same size and weight of a cup of coffee) on its top platform (trunk) so as to depict the effectiveness of the controller in achieving a steady trunk orientation. The video shows that the mass remains balanced only when the controller is active. When deactivated, the mass falls almost immediately as the robot begins to walk.
%
%
%
\begin{figure}[t!]
	\centering
	\begin{subfigure}{0.475\textwidth}
		\centering
		\SetImage{\ImageWidthRatioSub}{alpha0125_V_60mms_nN_50_nL_2_pos.png}
		\caption{ }
	\end{subfigure}
	\begin{subfigure}{0.475\textwidth}
		\centering
		\SetImage{\ImageWidthRatioSub}{alpha0250_V_60mms_nN_50_nL_2_pos.png}
		\caption{ }
	\end{subfigure}
	\begin{subfigure}{0.475\textwidth}
		\centering
		\SetImage{\ImageWidthRatioSub}{alpha0350_V_60mms_nN_50_nL_2_pos.png}
		\caption{ }
	\end{subfigure}
	\caption{ Trunk orientation during 60 $\frac{mm}{s}$ gait with mixing parameter set to
		 \textbf{a)}  $\alpha = 0.125$ 
		 \textbf{b)}  $\alpha = 0.250$ 
		 \textbf{c)}  $\alpha = 0.350$.
		Dark-shaded regions depict when the compensator is not active.
	}
	\label{fig::alpha_tests}
	\vspace{-6mm}
\end{figure}


